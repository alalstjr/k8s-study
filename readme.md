# 쿠버네티스는 어떻게 구성되어 있을까?

- api
- etcd
- c-m (컨트롤 매니저)
- sched
- CoreDNS
- k-proxy
- cni
- kubelet

## 구역을 나누는 네임스페이스(Namespace)

> kubectl get pods -n kube-system

명령어를 실행하면 구성하는 구역의 목록을 확인하실 수 있습니다.

### 다른 클라우드 에서도 동일하게 구성요소가 세팅되어 있을까?

- AWS EKS (Elastic Kubernetes Service)
  - aws-node
  - coredns
  - kube-proxy
- Azure AKS
  - coredns
  - kube-proxy
  - metrics-server
  - omsagent
  - tunnelfront
- GCP GKE (Google Kubernetes Engine)
  - event-exporter-gke
  - fluentbit-gke
  - gke-metrics
  - kube-dns
  - kube-proxy
  - metrics-server
  - pdcsi-node

3사의 관리형 쿠버네티스 구성 요소가 차이가 많이 있고 이런 구성 요소들을 보여주지 않습니다.

# 쿠버네티스의 기본 철학 (MSA)

마이크로서비스 아키텍처 = 하는 일들이 개별적으로 나누어있음  
이의 반대되는 것은 모놀리식 아키텍처 = 하나에 모두가 참여되어 있음

## 파드가 배포되면?

- 사용자 kubectl create pod(s) 파드 생성 요청
  - API 서버 & etcd 로 넘어갑니다.
- API 서버가 모든것의 중심에 있습니다.
  - pod(s) 생성 요청을 받으면 c-m (컨트롤러 매니저) 로 파드의 생성되었는지 감시하도록 합니다.
  - 그리하여 API 서버가 모든 상태값 모든 중심에 있습니다.
  - API 는 감시만하고 선언한 값만 가지고 있습니다
- 스케줄러가 각 pod 들을 배포를 하도록 스케줄 하는것 까지만 담당
  - API는 새로운 pod 가 워커 노드가 들어갔는지 감시
  - 스케줄러는 새로운 파드가 워크 노드에 넣도록 스케줄 함
- API 는 Kubelet 에게 새로운 파드가 노드에 잘 소속되어 있는지 감시
- Kubelet -> docker 파드의 동작관리
  - docker 컨테이너 런타임이 컨테이너 생성

API 서버는 중앙에서 상태값을 가지고 있으며 그 상태를 c-m, sched, Kubelet 등이 계속 맞추려고 합니다.  
이렇게 API 서버가 선언한다는 방식을 `선언적인 시스템` 이라고 합니다.

추구하는 상태와 현재 상태를 동일하게 맞추려고함  
이를 [ 상태변경 -> 감시 -> 차이발견 ] 을 무한 반복

API 서버와 etcd 서버의 방식은 조금 다릅니다.  
API 서버는 가지고 있는 현재상태 추구하는 값을 가지고 있는데 중간에 사라질 수 있으니  
매번 클러스터의 업데이트된 정보를 etcd 공간에 저장을 합니다.

# 실제 쿠버네티스의 파드 배포 흐름

- 마스터 노드 (m-k8s) - 관리자, 개발자
  - 워크 노드#1 - 사용자
  - 워크 노드#2 - 사용자
  - 워크 노드#3 - 사용자

마스터 노드에서 개발자가 kubectl 명령어로 API 서버에 요청합니다.  
API 서버는 etcd 에 해당 요청 정보를 업데이트를 진행합니다.
문제가 생기면 복구하는 방법은 etcd 에 있습니다.

다음 c-m 으로 통신합니다.  
API 서버의 값을 c-m 가 보고 자신의 값을 바꾸고 API 서버에 업데이트를 진행합니다.

스케줄러는 워크로드에 파드를 로드밸런싱 하게 도와줍니다.  
파드가 각각의 워커 노드에 밸러드 되게 들어가도록 도와주는 역할을 합니다.

API 서버를 보고 Kubelet 이 각각의 워커 노드에게 컨테이너 런타임에게 파드를 생성하도록 요청합니다.

각각의 워커 노드에서 컨테이너 런타임이 파드를 생성합니다.

이렇게 생성된 파드들은 사용자와 통신하기 위해서 kube-proxy 를 통해서 통신하게 됩니다.

이러한 네트워크는 쿠버네티스에서 기본 제공을 하지 않고  
사용자에서 직접 선택하게끔 하고있습니다. 이를 컨테이너 네트워크 인터페이스라고 합니다.  
예를들어 calico 를 사용했습니다.
